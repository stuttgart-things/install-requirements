---
- name: Check if pip3 is installed
  ansible.builtin.shell: |
    ls /usr/bin /usr/local/bin | grep pip3
  register: pip3_installation_status
  tags: python
  changed_when: false
  ignore_errors: true

- name: Check if python3 is installed (pip3 was not found)
  ansible.builtin.shell: |
    ls /usr/bin /usr/local/bin | grep -E "^python3"
  register: python3_installation_status
  when: pip3_installation_status.rc == 1
  tags: python
  changed_when: false
  ignore_errors: true

- name: Install python3 (python3 was not found)
  ansible.builtin.include_role:
    name: install-configure-python3
  when: pip3_installation_status.rc == 1 and python3_installation_status is defined and python3_installation_status.rc == 1
  tags: python

- name: Make sure pip is installed
  ansible.builtin.package:
    name: "{{ python_pip_name }}"
    state: present
  when: ansible_distribution_major_version != '7' and pip3_installation_status.rc == 1
  tags: python

- name: Check version of pip
  ansible.builtin.shell: |
    pip --version | cut -d ' ' -f 2
  ignore_errors: true
  changed_when: false
  register: pip_version

- name: Downgrade pip
  ansible.builtin.shell: |
    pip install pip==22.3.1 --break-system-packages
  when: python_modules is defined
  tags: python
  changed_when: false
  # when: pip_version.stdout is version('22.3.1', '>')
  ignore_errors: true

- name: Ensure Python 3.12 and venv are installed
  apt:
    name:
      - python3.12
      - python3.12-venv
      - python3.12-dev
    state: present
  become: true
 
- name: Create a virtual environment
  command: python3.12 -m venv /opt/k3s-venv
  args:
    creates: /opt/k3s-venv
  become: true
 
- name: Ensure pip is available in the virtual environment
  command: /opt/k3s-venv/bin/python3 -m ensurepip --upgrade
  args:
    creates: /opt/k3s-venv/bin/pip
  become: true
 
- name: Install required Python modules in venv
  command: /opt/k3s-venv/bin/python3 -m pip install packaging kubernetes openshift
  become: true
 
- name: Set interpreter for later tasks
  set_fact:
    ansible_python_interpreter: /opt/k3s-venv/bin/python
 
- name: Install additional Python modules in venv
  ansible.builtin.pip:
    name: "{{ item.name }}"
    version: "{{ item.version | default(omit) }}"
    state: "{{ state | default('present') }}"
    executable: /opt/k3s-venv/bin/pip3
  loop: "{{ python_modules }}"
  when: python_modules is defined
  tags: python
  become: true